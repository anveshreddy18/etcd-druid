# CRD Validations for etcd

* The validations for the fields within the `etcd` resource are done via [kubebuilder markers for CRD validation](https://book.kubebuilder.io/reference/markers/crd-validation). 
* The validations themselves are written using a combination of [CEL expressions](https://kubernetes.io/docs/reference/using-api/cel/) via the `x-validation` tag which provides a straightforward syntax to write validation rules for the fields, and pattern matching with the use of the `validation` tag.
* Upon any changes to the validation rules to the etcd resource, the `yaml` files for the same can be generated by running the `make generate` command.

## Validation rules:
### Type Validation rules:
The validations for fields of types `Duration`(metav1.Duration) and `cron` expressions are done via `regex` matching. (The checking for the `Quantity`(resource.Quantity) fields are done by default, hence, no explicit validation is needed for the fields of this type):
* Duration fields: 
`self.matches('^([0-9]+([.][0-9]+)?h)?([0-9]+([.][0-9]+)?m)?([0-9]+([.][0-9]+)?s)?([0-9]+([.][0-9]+)?d)?$')`
* Cron expression validations are done by using the `validation:Pattern` marker instead of the CEL expressions due to the way `escape characters` are handled while generating yaml files from these markers.
`\\/@(annually|yearly|monthly|weekly|daily|hourly|reboot)|\\/@every (\\d+(ns|us|Âµs|ms|s|m|h))+|(((\\d+,)+\\d+|\\d+(\\/|-)\\d+|\\d+|\\*|\\d+(-\\d+)?(,\\d+(-\\d+)?)*) ?){5,7}`

### Update validations
These validations are triggered when an update operation is done on the etcd resource.
* Immutable fields: The fields `etcd.spec.StorageClass` , `etcd.spec.StorageCapacity` and `etcd.spec.VolumeClaimTemplate` are immutable. The immutability is enforced by the CEL expression : `self == oldSelf`.

* The value set for the field `etcd.spec.replicas` can either be decreased to `0` or increased. This is enforced by the CEL expression:
    `self==0 ? true : self < oldSelf ? false : true`

### Field validations
- The fields which expect only a particular set of values are checked by using the kubebuilder marker: `+kubebuilder:validation:Enum=<value1>;<value2>`
    * The `etcd.spec.etcd.metrics` can only be set as either `basic` or `extesnive`.
    * The `etcd.spec.backup.garbageCollectionPolicy` can only be set as `Exponential` or `LimitBased`
    * The `etcd.spec.backup.compression.policy` can only be set as either `gzip` or `lzw` or `zlib`.
    * The `etcd.spec.sharedConfig.autoCompactionMode` can only be set as either `periodic` or `revision`.


* The value of `etcd.spec.backup.garbageCollectionPeriod` must be greater than `etcd.spec.backup.deltaSnapshotPeriod`. This is enforced by the CEL expression
`!(has(self.deltaSnapshotPeriod) && has(self.garbageCollectionPeriod)) || duration(self.deltaSnapshotPeriod).getSeconds() < duration(self.garbageCollectionPeriod).getSeconds()`. The first part of the expression ensures that both the fields are present and then compares the values of the garbageCollectionPeriod and deltaSnapshotPeriod fields, if not, skips the check.

* The value of `etcd.spec.StorageCapacity` must be more than 3 times that of the `etcd.spec.etcd.quota` if backups are enabled. If not, the value must be greater than that of the `etcd.spec.etcd.quota` field. This is enforced by using the CEL expression: 
`has(self.storageCapacity) && has(self.etcd.quota) ? (has(self.backup.store) ? quantity(self.storageCapacity).compareTo(quantity(self.etcd.quota).add(quantity(self.etcd.quota)).add(quantity(self.etcd.quota))) > 0 : quantity(self.storageCapacity).compareTo(quantity(self.etcd.quota)) > 0 ): true`
The check for whether backups are enabled or not is done by checking if the field `etcd.spec.backup.store` exists.